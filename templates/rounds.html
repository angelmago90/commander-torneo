<!doctype html>
<html lang="es" data-bs-theme="dark">
<head>
  <meta charset="utf-8">
  <title>Rondas ‚Äî Torneo Commander</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='dark.css') }}" rel="stylesheet">
</head>
<body class="bg-light">
  <nav class="navbar navbar-dark">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="{{ url_for('index') }}">
        <img src="{{ url_for('static', filename='img/gamecomms.png') }}" class="brand-logo" alt="GameComms">
        <span>GameComms ‚Äî Torneo Commander</span>
      </a>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-light btn-sm" href="{{ url_for('index') }}">Clasificaci√≥n</a>
        <a class="btn btn-outline-light btn-sm" href="{{ url_for('rounds_view') }}">Rondas</a>
        {% if is_admin %}
          <a class="btn btn-outline-light btn-sm" href="{{ url_for('logout') }}">Cerrar sesi√≥n</a>
        {% else %}
          <a class="btn btn-outline-light btn-sm" href="{{ url_for('login') }}">Login admin</a>
        {% endif %}
      </div>
    </div>
  </nav>

  <div class="container py-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-3">
          {% for cat, msg in messages %}
            <div class="alert alert-{{cat}}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="hero mb-3 d-flex align-items-center gap-3">
      <img src="{{ url_for('static', filename='img/gamecomms.png') }}" class="brand-logo" alt="GameComms">
      <div>
        <h1 class="h3 mb-1">Rondas y resultados</h1>
        <small class="text-muted">Reglas: 1¬∫=3 ‚Ä¢ 2¬∫=2 ‚Ä¢ 3¬∫=1 ‚Ä¢ Barrida=solo 1¬∫ suma ‚Ä¢ Salvavidas=+1</small>
      </div>
      {% if is_admin %}
        <div class="mb-3 d-flex gap-2">
          <form method="post" action="{{ url_for('round_add') }}">
            <button class="btn btn-primary btn-sm">+ Agregar ronda</button>
          </form>
          <a class="btn btn-outline-light btn-sm" href="{{ url_for('players_admin') }}">Gestionar jugadores</a>
        </div>
      {% endif %}
    </div>

    {% for r in rounds %}
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">Ronda {{ r.number }}</h4>
              {% if is_admin %}
                <div class="d-flex align-items-center gap-2">
                  <a class="btn btn-outline-primary btn-sm"
                    href="{{ url_for('round_edit', round_no=r.number) }}">Editar mesas</a>
                  <form class="d-inline"
                        method="post"
                        action="{{ url_for('round_clear', round_no=r.number) }}"
                        onsubmit="return confirm('¬øVaciar todas las mesas de la ronda {{ r.number }}? Se mantienen los descansos.');">
                    <button class="btn btn-outline-warning btn-sm">Vaciar ronda</button>
                  </form>
                  <form class="d-inline"
                        method="post"
                        action="{{ url_for('round_delete', round_no=r.number) }}"
                        onsubmit="return confirm('¬øEliminar por completo la ronda {{ r.number }}? ¬°No se puede deshacer!');">
                    <button class="btn btn-outline-danger btn-sm">Eliminar ronda</button>
                  </form>
                  <form class="d-flex align-items-center gap-2"
                        method="post"
                        action="{{ url_for('round_set_bye', round_no=r.number) }}">
                    <label class="form-label mb-0">Descanso:</label>
                    <select class="form-select form-select-sm" name="bye_player_id" style="width: 220px;">
                      <option value="none">Nadie</option>
                      {% for p in players_all %}
                        <option value="{{ p.id }}" {% if r.bye_id == p.id %}selected{% endif %}>{{ p.name }}</option>
                      {% endfor %}
                    </select>
                    <button class="btn btn-sm btn-primary">Guardar</button>
                  </form>
                </div>
              {% else %}
              {% if r.bye %}
                <span class="badge bg-secondary">Descanso: {{ r.bye }}</span>
              {% endif %}
            {% endif %}
          </div>

          <hr>

          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th style="width:80px;">Mesa</th>
                  <th>Jugadores (orden por posici√≥n)</th>
                  <th style="width:150px;">Ganador</th>
                  <th style="width:150px;">Segundo</th>
                  <th style="width:150px;">Tercero</th>
                  <th style="width:150px;">Salvavidas</th>
                  <th>Carta baneada</th>
                  {% if is_admin %}<th style="width:230px;">Acciones</th>{% endif %}
                </tr>
              </thead>
              <tbody>
                {% for g in r.games %}
                  <tr class="{% if g.played %}game-played{% endif %}">
                    <td>
                      <strong>
                        {% if g.played %}
                          <span class="badge bg-success me-1">‚úì</span>
                        {% endif %}
                        {{ g.table }}
                      </strong>
                    </td>
                    <td class="{% if g.played %}played-underline{% endif %}">
                      {% for p in g.participants %}
                        <span class="me-2">
                          {{ p.name }}{% if p.pos %} <small class="text-muted">(pos {{ p.pos }})</small>{% endif %}
                        </span>
                      {% endfor %}
                      {% if g.sweep %}
                        <span class="badge bg-warning text-dark ms-2">Barrida</span>
                      {% endif %}
                    </td>
                    <td>{{ g.winner or "‚Äî" }}</td>
                    <td>{{ g.second or "‚Äî" }}</td>
                    <td>{{ g.third  or "‚Äî" }}</td>
                    <td>{% if g.save %}<span class="badge bg-info">üõ°Ô∏è {{ g.save }}</span>{% else %}‚Äî{% endif %}</td>
                    <td>
                      {% if g.banned %}
                        <span class="scryfall-card" data-cardname="{{ g.banned }}">{{ g.banned }}</span>
                      {% else %}‚Äî{% endif %}
                    </td>
                    {% if is_admin %}
                      <td class="text-nowrap">
                        <a class="btn btn-outline-primary btn-sm"
                          href="{{ url_for('game_edit', game_id=g.id) }}">Editar</a>

                        <form method="post" action="{{ url_for('game_reset', game_id=g.id) }}"
                              class="d-inline"
                              onsubmit="return confirm('¬øVaciar esta mesa? Se borran posiciones, barrida, salvavidas y baneada.');">
                          <button class="btn btn-outline-warning btn-sm">Vaciar</button>
                        </form>

                        <form method="post" action="{{ url_for('game_delete', game_id=g.id) }}"
                              class="d-inline"
                              onsubmit="return confirm('¬øEliminar esta mesa por completo? Esta acci√≥n no se puede deshacer.');">
                          <button class="btn btn-outline-danger btn-sm">Eliminar</button>
                        </form>
                      </td>
                    {% endif %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

        </div>
      </div>
    {% endfor %}
  </div>

  <!-- Scryfall hover preview -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const cache = new Map(); // name -> imageURL|null
    const preview = document.createElement('div');
    preview.className = 'scryfall-preview';
    preview.style.display = 'none';
    preview.innerHTML = '<div class="inner"></div>';
    document.body.appendChild(preview);
    const inner = preview.querySelector('.inner');

    function positionPreview(e) {
      const pad = 16;
      let x = e.clientX + pad;
      let y = e.clientY + pad;
      const rect = preview.getBoundingClientRect();
      const vw = window.innerWidth, vh = window.innerHeight;
      if (x + rect.width > vw) x = e.clientX - rect.width - pad;
      if (y + rect.height > vh) y = e.clientY - rect.height - pad;
      preview.style.left = x + 'px';
      preview.style.top  = y + 'px';
    }

    async function fetchImage(name) {
      if (cache.has(name)) return cache.get(name);
      try {
        // fuzzy tolera typos ("Peregrin Took", "Ureni..." etc.)
        const url = 'https://api.scryfall.com/cards/named?fuzzy=' + encodeURIComponent(name);
        const res = await fetch(url);
        if (!res.ok) { cache.set(name, null); return null; }
        const data = await res.json();
        let img = null;
        if (data.image_uris) {
          img = data.image_uris.normal || data.image_uris.large || data.image_uris.small;
        } else if (Array.isArray(data.card_faces) && data.card_faces[0]?.image_uris) {
          img = data.card_faces[0].image_uris.normal || data.card_faces[0].image_uris.large || data.card_faces[0].image_uris.small;
        }
        cache.set(name, img);
        return img;
      } catch (e) {
        cache.set(name, null);
        return null;
      }
    }

    function show(url, name) {
      if (!url) return;
      inner.innerHTML = `<img src="${url}" alt="${name}" style="display:block; max-width:280px; height:auto; border-radius:10px;">`;
      preview.style.display = 'block';
    }
    function hide() { preview.style.display = 'none'; }

    document.addEventListener('mouseover', async (e) => {
      const el = e.target.closest('.scryfall-card');
      if (!el) return;
      positionPreview(e);
      const name = el.getAttribute('data-cardname');
      const url  = await fetchImage(name);
      show(url, name);
    });
    document.addEventListener('mousemove', (e) => {
      if (preview.style.display === 'block') positionPreview(e);
    });
    document.addEventListener('mouseout', (e) => {
      if (e.relatedTarget && e.relatedTarget.closest && e.relatedTarget.closest('.scryfall-card')) return;
      hide();
    });
  });
  </script>
</body>
</html>
